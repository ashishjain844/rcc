"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const passport_1 = require("passport");
const jsonwebtoken_1 = require("jsonwebtoken");
const environments_1 = require("../../environments");
const data_1 = require("../../data");
function login(req, res, next) {
    // authenticate with passport
    passport_1.authenticate('admin-local', { session: false }, function (error, result) {
        // auth error
        if (error)
            return res.status(500).json({ message: data_1.response.INTERNAL_ERROR });
        // user not accessible
        if (!result.data)
            return res.status(result.status).send({ message: result.message });
        req.login(result.data, { session: false }, function (loginError) {
            console.log(loginError);
            // error in login to request
            if (loginError)
                return res.status(500).json({ message: data_1.response.INTERNAL_ERROR });
            // success response
            const token = jsonwebtoken_1.sign({ id: result.data._id }, environments_1.config.JWT_SECRET);
            return res.json({ message: data_1.response.LOGIN_SUCCESS, data: { token } });
        });
    })(req, res, next);
}
exports.login = login;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYXBwaW52ZW50aXZyaC0wNTgvQXNoaXNoLXdvcmsvcmNjL2FwaS9jb250cm9sbGVycy9hZG1pbi9sb2dpbi50cyIsInNvdXJjZXMiOlsiL2hvbWUvYXBwaW52ZW50aXZyaC0wNTgvQXNoaXNoLXdvcmsvcmNjL2FwaS9jb250cm9sbGVycy9hZG1pbi9sb2dpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLHVDQUF3QztBQUV4QywrQ0FBb0M7QUFDcEMscURBQTRDO0FBQzVDLHFDQUFzQztBQUV0QyxlQUFzQixHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCO0lBRWpFLDZCQUE2QjtJQUM3Qix1QkFBWSxDQUFDLGFBQWEsRUFBRSxFQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUMsRUFBRSxVQUFTLEtBQUssRUFBRSxNQUF1QjtRQUNqRixhQUFhO1FBQ2IsSUFBSSxLQUFLO1lBQUUsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxlQUFRLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztRQUU3RSxzQkFBc0I7UUFDdEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJO1lBQUUsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sRUFBQyxDQUFDLENBQUM7UUFFbkYsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUMsT0FBTyxFQUFFLEtBQUssRUFBQyxFQUFFLFVBQVMsVUFBVTtZQUN4RCxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3hCLDRCQUE0QjtZQUM1QixJQUFJLFVBQVU7Z0JBQUUsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRSxlQUFRLENBQUMsY0FBYyxFQUFDLENBQUMsQ0FBQztZQUVoRixtQkFBbUI7WUFDbkIsTUFBTSxLQUFLLEdBQUcsbUJBQUksQ0FBQyxFQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBQyxFQUFFLHFCQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDN0QsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLGVBQVEsQ0FBQyxhQUFhLEVBQUUsSUFBSSxFQUFFLEVBQUMsS0FBSyxFQUFDLEVBQUMsQ0FBQyxDQUFBO1FBQ3JFLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUN2QixDQUFDO0FBcEJELHNCQW9CQyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQgeyBhdXRoZW50aWNhdGUgfSBmcm9tIFwicGFzc3BvcnRcIjtcbmltcG9ydCB7IE9wZXJhdGlvblJlc3VsdCB9IGZyb20gXCIuLi8uLi90eXBpbmdzXCI7XG5pbXBvcnQgeyBzaWduIH0gZnJvbSBcImpzb253ZWJ0b2tlblwiO1xuaW1wb3J0IHsgY29uZmlnIH0gZnJvbSBcIi4uLy4uL2Vudmlyb25tZW50c1wiO1xuaW1wb3J0IHsgcmVzcG9uc2UgfSBmcm9tIFwiLi4vLi4vZGF0YVwiO1xuXG5leHBvcnQgZnVuY3Rpb24gbG9naW4ocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBcbiAgICAvLyBhdXRoZW50aWNhdGUgd2l0aCBwYXNzcG9ydFxuICAgIGF1dGhlbnRpY2F0ZSgnYWRtaW4tbG9jYWwnLCB7c2Vzc2lvbjogZmFsc2V9LCBmdW5jdGlvbihlcnJvciwgcmVzdWx0OiBPcGVyYXRpb25SZXN1bHQpIHtcbiAgICAgICAgLy8gYXV0aCBlcnJvclxuICAgICAgICBpZiAoZXJyb3IpIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6IHJlc3BvbnNlLklOVEVSTkFMX0VSUk9SIH0pO1xuICAgICAgICBcbiAgICAgICAgLy8gdXNlciBub3QgYWNjZXNzaWJsZVxuICAgICAgICBpZiAoIXJlc3VsdC5kYXRhKSByZXR1cm4gcmVzLnN0YXR1cyhyZXN1bHQuc3RhdHVzKS5zZW5kKHttZXNzYWdlOiByZXN1bHQubWVzc2FnZX0pO1xuXG4gICAgICAgIHJlcS5sb2dpbihyZXN1bHQuZGF0YSwge3Nlc3Npb246IGZhbHNlfSwgZnVuY3Rpb24obG9naW5FcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5sb2cobG9naW5FcnJvcik7XG4gICAgICAgICAgICAvLyBlcnJvciBpbiBsb2dpbiB0byByZXF1ZXN0XG4gICAgICAgICAgICBpZiAobG9naW5FcnJvcikgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHttZXNzYWdlOiByZXNwb25zZS5JTlRFUk5BTF9FUlJPUn0pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBzdWNjZXNzIHJlc3BvbnNlXG4gICAgICAgICAgICBjb25zdCB0b2tlbiA9IHNpZ24oe2lkOiByZXN1bHQuZGF0YS5faWR9LCBjb25maWcuSldUX1NFQ1JFVCk7XG4gICAgICAgICAgICByZXR1cm4gcmVzLmpzb24oe21lc3NhZ2U6IHJlc3BvbnNlLkxPR0lOX1NVQ0NFU1MsIGRhdGE6IHt0b2tlbn19KVxuICAgICAgICB9KTtcbiAgICB9KShyZXEsIHJlcywgbmV4dCk7XG59XG5cbiJdfQ==