"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const passport_1 = require("passport");
const jsonwebtoken_1 = require("jsonwebtoken");
const environments_1 = require("../../environments");
const data_1 = require("../../data");
function login(req, res, next) {
    // authenticate with passport
    passport_1.authenticate('user-local', { session: false }, function (error, result) {
        // auth error
        if (error)
            return res.status(500).json({ message: data_1.response.INTERNAL_ERROR });
        // user not accessible
        if (!result.data)
            return res.status(result.status).send({ message: result.message });
        req.login(result.data, { session: false }, function (loginError) {
            // error in login to request
            if (loginError)
                return res.status(500).json({ message: data_1.response.INTERNAL_ERROR });
            // success response
            const token = jsonwebtoken_1.sign({ id: result.data._id }, environments_1.config.JWT_SECRET);
            return res.json({ message: data_1.response.LOGIN_SUCCESS, token });
        });
    })(req, res, next);
}
exports.login = login;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYXBwaW52ZW50aXZyaC0wNTgvQXNoaXNoLXdvcmsvcmNjL2FwaS9jb250cm9sbGVycy91c2VyL2xvZ2luLnRzIiwic291cmNlcyI6WyIvaG9tZS9hcHBpbnZlbnRpdnJoLTA1OC9Bc2hpc2gtd29yay9yY2MvYXBpL2NvbnRyb2xsZXJzL3VzZXIvbG9naW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSx1Q0FBd0M7QUFFeEMsK0NBQW9DO0FBQ3BDLHFEQUE0QztBQUM1QyxxQ0FBc0M7QUFFdEMsZUFBc0IsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQjtJQUVqRSw2QkFBNkI7SUFDN0IsdUJBQVksQ0FBQyxZQUFZLEVBQUUsRUFBQyxPQUFPLEVBQUUsS0FBSyxFQUFDLEVBQUUsVUFBUyxLQUFLLEVBQUUsTUFBdUI7UUFDaEYsYUFBYTtRQUNiLElBQUksS0FBSztZQUFFLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsZUFBUSxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUM7UUFFN0Usc0JBQXNCO1FBQ3RCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSTtZQUFFLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUMsQ0FBQyxDQUFDO1FBRW5GLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxFQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUMsRUFBRSxVQUFTLFVBQVU7WUFDeEQsNEJBQTRCO1lBQzVCLElBQUksVUFBVTtnQkFBRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLGVBQVEsQ0FBQyxjQUFjLEVBQUMsQ0FBQyxDQUFDO1lBRWhGLG1CQUFtQjtZQUNuQixNQUFNLEtBQUssR0FBRyxtQkFBSSxDQUFDLEVBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFDLEVBQUUscUJBQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUM3RCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBQyxPQUFPLEVBQUUsZUFBUSxDQUFDLGFBQWEsRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFBO1FBQzdELENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUN2QixDQUFDO0FBbkJELHNCQW1CQyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQgeyBhdXRoZW50aWNhdGUgfSBmcm9tIFwicGFzc3BvcnRcIjtcbmltcG9ydCB7IE9wZXJhdGlvblJlc3VsdCB9IGZyb20gXCIuLi8uLi90eXBpbmdzXCI7XG5pbXBvcnQgeyBzaWduIH0gZnJvbSBcImpzb253ZWJ0b2tlblwiO1xuaW1wb3J0IHsgY29uZmlnIH0gZnJvbSBcIi4uLy4uL2Vudmlyb25tZW50c1wiO1xuaW1wb3J0IHsgcmVzcG9uc2UgfSBmcm9tIFwiLi4vLi4vZGF0YVwiO1xuXG5leHBvcnQgZnVuY3Rpb24gbG9naW4ocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBcbiAgICAvLyBhdXRoZW50aWNhdGUgd2l0aCBwYXNzcG9ydFxuICAgIGF1dGhlbnRpY2F0ZSgndXNlci1sb2NhbCcsIHtzZXNzaW9uOiBmYWxzZX0sIGZ1bmN0aW9uKGVycm9yLCByZXN1bHQ6IE9wZXJhdGlvblJlc3VsdCkge1xuICAgICAgICAvLyBhdXRoIGVycm9yXG4gICAgICAgIGlmIChlcnJvcikgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogcmVzcG9uc2UuSU5URVJOQUxfRVJST1IgfSk7XG4gICAgICAgIFxuICAgICAgICAvLyB1c2VyIG5vdCBhY2Nlc3NpYmxlXG4gICAgICAgIGlmICghcmVzdWx0LmRhdGEpIHJldHVybiByZXMuc3RhdHVzKHJlc3VsdC5zdGF0dXMpLnNlbmQoe21lc3NhZ2U6IHJlc3VsdC5tZXNzYWdlfSk7XG5cbiAgICAgICAgcmVxLmxvZ2luKHJlc3VsdC5kYXRhLCB7c2Vzc2lvbjogZmFsc2V9LCBmdW5jdGlvbihsb2dpbkVycm9yKSB7XG4gICAgICAgICAgICAvLyBlcnJvciBpbiBsb2dpbiB0byByZXF1ZXN0XG4gICAgICAgICAgICBpZiAobG9naW5FcnJvcikgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHttZXNzYWdlOiByZXNwb25zZS5JTlRFUk5BTF9FUlJPUn0pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBzdWNjZXNzIHJlc3BvbnNlXG4gICAgICAgICAgICBjb25zdCB0b2tlbiA9IHNpZ24oe2lkOiByZXN1bHQuZGF0YS5faWR9LCBjb25maWcuSldUX1NFQ1JFVCk7XG4gICAgICAgICAgICByZXR1cm4gcmVzLmpzb24oe21lc3NhZ2U6IHJlc3BvbnNlLkxPR0lOX1NVQ0NFU1MsIHRva2VufSlcbiAgICAgICAgfSk7XG4gICAgfSkocmVxLCByZXMsIG5leHQpO1xufVxuXG4iXX0=