"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const jsonwebtoken_1 = require("jsonwebtoken");
const model_1 = require("../model");
const environments_1 = require("../../../environments");
const data_1 = require("../../../data");
const utils_1 = require("../../../utils");
function forgot(username) {
    return new Promise(function (resolve, reject) {
        model_1.Admin.countDocuments({ username, statusCode: 1 }).then(function (count) {
            if (count > 0) {
                const token = jsonwebtoken_1.sign({ username }, environments_1.config.JWT_SECRET, {
                    expiresIn: 60 * 60
                });
                const resetLink = `${environments_1.config.CLIENT_SIDE_URI}/reset-password/${token}`;
                const template = utils_1.resetTemplate('User', resetLink);
                utils_1.sendEmail({ to: username, subject: 'Reset Password', text: resetLink, html: template }).then((info) => {
                    resolve({ status: 200, message: data_1.response.FORGOT_MAIL_SENT });
                }).catch(reject);
            }
            else {
                resolve({ status: 422, message: data_1.response.ACCOUNT_NOT_FOUND });
            }
        }).catch(reject);
    });
}
exports.forgot = forgot;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvYXBwaW52ZW50aXZyaC0wNTgvQXNoaXNoLXdvcmsvcmNjL2FwaS9kYi9hZG1pbi9vcGVyYXRpb25zL2ZvcmdvdC50cyIsInNvdXJjZXMiOlsiL2hvbWUvYXBwaW52ZW50aXZyaC0wNTgvQXNoaXNoLXdvcmsvcmNjL2FwaS9kYi9hZG1pbi9vcGVyYXRpb25zL2ZvcmdvdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtDQUFvQztBQUNwQyxvQ0FBaUM7QUFDakMsd0RBQStDO0FBRS9DLHdDQUF5QztBQUN6QywwQ0FBMEQ7QUFFMUQsZ0JBQXlCLFFBQWdCO0lBQ3JDLE9BQU8sSUFBSSxPQUFPLENBQUMsVUFBUyxPQUFPLEVBQUUsTUFBTTtRQUN2QyxhQUFLLENBQUMsY0FBYyxDQUFDLEVBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxDQUFDLEVBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFTLEtBQUs7WUFDL0QsSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFO2dCQUNYLE1BQU0sS0FBSyxHQUFHLG1CQUFJLENBQUMsRUFBQyxRQUFRLEVBQUMsRUFBRSxxQkFBTSxDQUFDLFVBQVUsRUFBRTtvQkFDOUMsU0FBUyxFQUFFLEVBQUUsR0FBRyxFQUFFO2lCQUNyQixDQUFDLENBQUM7Z0JBQ0gsTUFBTSxTQUFTLEdBQUcsR0FBRyxxQkFBTSxDQUFDLGVBQWUsbUJBQW1CLEtBQUssRUFBRSxDQUFDO2dCQUN0RSxNQUFNLFFBQVEsR0FBRyxxQkFBYSxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztnQkFDbEQsaUJBQVMsQ0FBQyxFQUFDLEVBQUUsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7b0JBQ2hHLE9BQU8sQ0FBQyxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLGVBQVEsQ0FBQyxnQkFBZ0IsRUFBQyxDQUFDLENBQUE7Z0JBQzlELENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUNwQjtpQkFBTTtnQkFDSCxPQUFPLENBQUMsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxlQUFRLENBQUMsaUJBQWlCLEVBQUMsQ0FBQyxDQUFDO2FBQy9EO1FBQ0wsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3JCLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQWpCRCx3QkFpQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzaWduIH0gZnJvbSAnanNvbndlYnRva2VuJztcbmltcG9ydCB7IEFkbWluIH0gZnJvbSBcIi4uL21vZGVsXCI7XG5pbXBvcnQgeyBjb25maWcgfSBmcm9tICcuLi8uLi8uLi9lbnZpcm9ubWVudHMnO1xuaW1wb3J0IHsgT3BlcmF0aW9uUmVzdWx0IH0gZnJvbSAnLi4vLi4vLi4vdHlwaW5ncyc7XG5pbXBvcnQgeyByZXNwb25zZSB9IGZyb20gXCIuLi8uLi8uLi9kYXRhXCI7XG5pbXBvcnQgeyBzZW5kRW1haWwsIHJlc2V0VGVtcGxhdGUgfSBmcm9tICcuLi8uLi8uLi91dGlscyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBmb3Jnb3TigIvigIsodXNlcm5hbWU6IHN0cmluZyk6IFByb21pc2U8T3BlcmF0aW9uUmVzdWx0PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBBZG1pbi5jb3VudERvY3VtZW50cyh7dXNlcm5hbWUsIHN0YXR1c0NvZGU6IDF9KS50aGVuKGZ1bmN0aW9uKGNvdW50KSB7XG4gICAgICAgICAgICBpZiAoY291bnQgPiAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBzaWduKHt1c2VybmFtZX0sIGNvbmZpZy5KV1RfU0VDUkVULCB7XG4gICAgICAgICAgICAgICAgICAgIGV4cGlyZXNJbjogNjAgKiA2MFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc2V0TGluayA9IGAke2NvbmZpZy5DTElFTlRfU0lERV9VUkl9L3Jlc2V0LXBhc3N3b3JkLyR7dG9rZW59YDtcbiAgICAgICAgICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHJlc2V0VGVtcGxhdGUoJ1VzZXInLCByZXNldExpbmspO1xuICAgICAgICAgICAgICAgIHNlbmRFbWFpbCh7dG86IHVzZXJuYW1lLCBzdWJqZWN0OiAnUmVzZXQgUGFzc3dvcmQnLCB0ZXh0OiByZXNldExpbmssIGh0bWw6IHRlbXBsYXRlfSkudGhlbigoaW5mbykgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtzdGF0dXM6IDIwMCwgbWVzc2FnZTogcmVzcG9uc2UuRk9SR09UX01BSUxfU0VOVH0pXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2gocmVqZWN0KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh7c3RhdHVzOiA0MjIsIG1lc3NhZ2U6IHJlc3BvbnNlLkFDQ09VTlRfTk9UX0ZPVU5EfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pLmNhdGNoKHJlamVjdCk7XG4gICAgfSk7XG59Il19